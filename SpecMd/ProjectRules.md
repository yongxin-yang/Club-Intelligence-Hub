# 项目通用开发规范 (ProjectRules)

## 1. 语言与命名

- 对话语言: 英文为主，便于英语实践。
- 代码注释与规范文档: 使用中文，确保表达准确。
- 模块/文件/类/函数命名: 使用有意义的英文单词，保持简洁明确。

## 2. 环境与依赖管理

- 操作系统: Windows。
- Python 版本约束:
  - 项目要求 Python 版本为 `>=3.12,<3.14`。
  - 推荐优先使用 3.12.x, 可在确认依赖兼容后升级到 3.13.x。
- Python 环境管理 (必须通过 my-uv 完成):
  - 所有虚拟环境的创建、激活与删除必须通过自制 my-uv 工具完成，禁止直接使用 `python -m venv` 或让 `uv sync` 在项目目录下自动创建 `.venv`。
  - 本项目默认环境名称: `CIH1`，物理路径与项目目录分离，由 my-uv 统一管理。
  - 推荐创建方式示例 (根据实际 Python 安装情况选择 3.12 或 3.13):
    - `my-uv new CIH1 3.12`
  - 常用命令:
    - `my-uv activate CIH1` 激活环境。
    - `my-uv deactivate` 停用当前环境。
    - `my-uv list` 查看已有环境。
  - 所有 Python 相关开发与运行步骤，都应在激活 CIH1 环境后进行，并保证环境 Python 版本满足 `>=3.12,<3.14`。
- 依赖声明与安装:
  - 统一使用 `pyproject.toml` (uv/PEP621 风格)，其中 `requires-python` 必须与上述版本约束保持一致。
  - 依赖同步应在已由 my-uv 激活的环境中，通过 uv 工具执行 (例如 `uv sync`)，但 uv 只负责读取 `pyproject.toml/uv.lock` 并安装包，不负责创建或管理虚拟环境。
  - 不使用额外的 `requirements.txt` 作为主依赖源，必要时由 uv 导出。

## 3. 架构与职责边界

- 严格遵守 PRD 中的架构思想:
  - 模型不直接访问业务系统。
  - 所有业务能力均通过 MCP 工具暴露。
- Gateway 层职责:
  - 提供统一 HTTP API，处理认证、路由与模式选择。
  - 调用 LLM 与 MCP Client，编排工具调用流程。
- MCP Server 层职责:
  - 将业务系统 API/数据库访问能力封装为工具。
  - 对 LLM 隐藏底层实现细节，保证接口稳定清晰。
- 禁止在单个模块中混合多个层的职责 (例如 Gateway 中直接访问数据库)。

## 4. 代码风格与错误处理

- 核心原则: 极简主义，仅保留必要业务逻辑。
- 错误处理:
  - 默认不使用大面积 `try-except` 包裹，允许错误抛出以便暴露问题。
  - 如确需捕获异常，必须打印精简但有用的错误信息，并包含完整堆栈:
    - `print(f"[ERROR] 异常堆栈:\n{traceback.format_exc()}")`
- 文件头注释:
  - 每个源代码文件必须在开头使用中文文档字符串/注释，说明:
    - 文件名与所属层级。
    - 主要类/函数与核心逻辑。
    - 调用链上下文 (谁调用本文件 / 本文件调用谁)。
    - 关键参数与返回数据结构概述。
- 不保留废弃代码:
  - 修复或重构时直接修改原实现，不保留大段注释掉的旧代码。

## 5. 交互模式与安全策略

- 交互模式定义:
  - Chat Mode: 统一查询/辅助操作入口，v0.1 主实现对象。
  - Agent Mode: AI 主动操控页面与状态，v0.2 以后实现。
  - Draft/Confirm Mode: AI 生成方案/草稿，由用户确认后执行，优先用于写操作。
- 安全策略:
  - 工具分为只读与写操作工具，写操作工具应支持二次确认机制 (规划阶段可在接口预留)。
  - 关键写操作需记录操作日志 (用户/工具/参数/时间/结果)。
  - 工具级权限控制与角色绑定在设计新工具时必须考虑，并在 SpecMd 中标注。
  - 所有 API Key/Token 等敏感信息不得写入代码文件，可存放于环境变量或本地未纳入版本控制的配置文件 (如 `config/keys.local.json`)，具体加载逻辑由 `app.core` 层统一管理。

## 6. 测试与验证

- 测试目录规划为 `test/` (当前版本可为空，后续补充)。
- 单文件内的 `if __name__ == "__main__":` 区块仅用于最小可运行示例或独立调试脚本。
- 重要变更应通过至少一种形式验证:
  - 单元测试/集成测试。
  - 手工调用 (如 curl/Postman) 验证 API 与工具链路。
  - 静态检查 (如类型检查、基础语法检查)。

## 7. 文档维护原则

- 所有结构与行为变更必须先更新 SpecMd 中的对应文档，再进行代码变更，或与代码变更保持同一提交。
- `Structure.md` 与 layer/workflow 文档要求与实际代码一一对应:
  - 新增/删除模块时必须同步修改文档。
  - 对输入输出结构有修改时，要在对应 layer/workflow 文档中更新。
